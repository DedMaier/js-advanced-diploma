!function(){"use strict";function e(e,t){let a="";const s=e+1;switch(s<=t&&(a+="top-"),s>t**2-t&&(a+="bottom-"),s%t){case 0:a+="right";break;case 1:a+="left";break;default:a=a.slice(0,-1)}return""!==a?a:"center"}class t{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(t){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n      <div class = "scores">\n        <div class="score">Score: <span data-id="current-score"></span></div>\n        <div class="score">Top score: <span data-id="top-score"></span></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(t);for(let t=0;t<this.boardSize**2;t+=1){const a=document.createElement("div");a.classList.add("cell","map-tile",`map-tile-${e(t,this.boardSize)}`),a.addEventListener("mouseenter",(e=>this.onCellEnter(e))),a.addEventListener("mouseleave",(e=>this.onCellLeave(e))),a.addEventListener("click",(e=>this.onCellClick(e))),this.boardEl.appendChild(a)}this.cells=Array.from(this.boardEl.children)}redrawPositions(e){this.hideRanges();for(const e of this.cells)e.innerHTML="";for(const a of e){const e=this.boardEl.children[a.position],s=document.createElement("div");s.classList.add("character",a.character.type);const i=document.createElement("div");i.classList.add("health-level");const r=document.createElement("div");r.classList.add("health-level-indicator","health-level-indicator-"+((t=a.character.health)<15?"critical":t<50?"normal":"high")),r.style.width=`${a.character.health}%`,i.appendChild(r),s.appendChild(i),e.appendChild(s)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(null,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(null,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(null,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(null)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(null)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(null)))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yellow";this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}colorCell(e,t){this.cells[e].classList.add("selected",`selected-${t}`)}uncolorCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showRanges(e,t){this.cells.forEach(((a,s)=>{e.includes(s)||a.classList.add("unavailable"),t.includes(s)&&a.classList.add("attack-range")}))}hideRanges(){this.cells.forEach((e=>{e.classList.remove(...Array.from(e.classList).filter((e=>e.startsWith("unavailable")||e.startsWith("attack"))))}))}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise((a=>{const s=this.cells[e],i=document.createElement("span");i.textContent=t,i.classList.add("damage"),s.appendChild(i),i.addEventListener("animationend",(()=>{s.removeChild(i),a()}))}))}setCursor(e){this.boardEl.style.cursor=e}setScore(e,t){this.container.querySelector(`[data-id=${e}-score]`).innerText=t}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}class a{constructor(e,t){this.side=e,this.characters=t}}class s{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"generic";if("Character"===new.target.name)throw new Error("Forbidden to create Character class instance");this.level=e,this.attack=0,this.defence=0,this.health=50,this.type=t}}function*i(e,t){const{length:a}=e;for(;;)yield new(e[Math.floor(Math.random()*a)])(Math.floor(1+Math.random()*t))}function*r(e){for(let t=0;t<e.length;t+=1){const a=e[t];yield class extends s{constructor(e){super(e),this.attack=a.attack,this.defence=a.defence,this.type=a.type,this.atkradius=a.atkradius,this.moveradius=a.moveradius}}}}function l(e,t,a){const s=[];1===t&&e.splice(2);const r=i(e,t);for(let e=0;e<a;e+=1)s.push(r.next().value);return s}class o{constructor(e,t){if(!(e instanceof s))throw new Error("character must be instance of Character or its children");if("number"!=typeof t)throw new Error("position must be a number");this.character=e,this.position=t}}class h{constructor(e){e?(this.playerteam=e.playerteam||null,this.enemyteam=e.enemyteam||null,this.positions=e.positions||null,this.stage=e.stage,this.level=e.level,this.score=e.score,this.topscore=e.topscore,this.selectedChar=e.selectedChar):(this.playerteam=null,this.enemyteam=null,this.positions=null,this.stage="select",this.level=1,this.score=0,this.topscore=0)}}class n{constructor(){this.themes=["prairie","desert","arctic","mountain"]}*[Symbol.iterator](){const{length:e}=this.themes;yield this.themes[Math.floor(Math.random()*e)]}}var c="auto",d="pointer",m="crosshair",g="not-allowed";const p=[{attack:40,defence:10,type:"swordsman",atkradius:1,moveradius:4},{attack:25,defence:25,type:"bowman",atkradius:2,moveradius:2},{attack:10,defence:40,type:"magician",atkradius:4,moveradius:1}],y=[{attack:40,defence:10,type:"undead",atkradius:1,moveradius:4},{attack:25,defence:25,type:"vampire",atkradius:2,moveradius:2},{attack:10,defence:40,type:"zombie",atkradius:4,moveradius:1}],v=new t;v.bindToDOM(document.querySelector("#game-container"));const u=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){return{}}}}(window.localStorage),C=new class{constructor(e,t){this.gamePlay=e,this.stateService=t,this.boardSize=8,this.themes=[...new n]}rebuildSavedTeam(e){let t;const s=new a(e.side,[]);t="player"===e.side?p:y,e.characters.forEach((e=>{const{position:a}=e,l=e.character,h=i([...r(t.filter((e=>e.type===l.type)))],l.level).next().value;h.level=l.level,h.attack=l.attack,h.defence=l.defence,h.health=l.health;const n=new o(h,a);s.characters.push(n)})),"player"===e.side?this.playerteam=s:this.enemyteam=s}positionTeam(e,t){for(let a=0;a<e.characters.length;a+=1){let s;e.characters[a]instanceof o?s=e.characters[a].position:(s=t[Math.floor(Math.random()*t.length)],"player"===e.side?this.playerteam.characters[a]=new o(e.characters[a],s):this.enemyteam.characters[a]=new o(e.characters[a],s)),t.splice(t.indexOf(s),1),this.positions.delete(s)}}positionTeams(e){let t=Array.from(this.positions);const a=this.boardSize;1===e&&(t=t.filter((e=>e%a==0||e%a==1))),this.positionTeam(this.playerteam,t),t=Array.from(this.positions),1===e&&(t=t.filter((e=>e%a==7||e%a==6))),this.positionTeam(this.enemyteam,t)}setScore(){this.gamePlay.setScore("current",this.gameState.score),this.gameState.score>this.gameState.topscore&&(this.gameState.topscore=this.gameState.score),this.gamePlay.setScore("top",this.gameState.topscore)}init(){if(this.gameState=new h(this.stateService.load()),this.gameState.playerteam?(this.rebuildSavedTeam(this.gameState.playerteam),this.rebuildSavedTeam(this.gameState.enemyteam)):(this.playerteam=new a("player",l([...r(p)],1,2)),this.enemyteam=new a("enemy",l([...r(y)],1,2))),this.positions=new Set(Array(this.boardSize**2).keys()),this.positionTeams(this.gameState.level||1),this.gamePlay.cellClickListeners.length||(this.gamePlay.drawUi(this.themes[0]),this.addCellEnterEvent(),this.addCellLeaveEvent(),this.addCellClickEvent(),this.addNewGameClickEvent(),this.addSaveGameClickEvent(),this.addLoadGameClickEvent()),this.gamePlay.redrawPositions(this.playerteam.characters.concat(this.enemyteam.characters)),this.setScore(),"move"===this.gameState.stage){const e=this.gameState.selectedChar.position;this.selectChar(this.playerteam.characters.filter((t=>t.position===e))[0])}}levelUp(){this.playerteam.characters.forEach((e=>{const t=e.character;this.gameState.score+=t.health,t.level+=1,t.health+=80,t.attack=Math.max(t.attack,t.attack*((1.8-t.health)/100)),t.health>=100&&(t.health=100)})),this.enemyteam=new a("enemy",l([...r(y)],this.gameState.level+1,this.playerteam.characters.length));const e=i([...r(p)],this.gameState.level);this.playerteam.characters.push(e.next().value),this.gameState.level+=1,this.gamePlay.drawUi(this.themes[0]),this.positions=new Set(Array(this.boardSize**2).keys()),this.positionTeams(this.gameState.level),this.gamePlay.redrawPositions(this.playerteam.characters.concat(this.enemyteam.characters)),this.setScore(),this.gameState.stage="select"}startNew(){this.setScore(),this.gameState.score=0,"move"===this.gameState.stage&&(this.gamePlay.deselectCell(this.gameState.selectedChar.position),this.gameState.selectedChar=null),this.playerteam=new a("player",l([...r(p)],1,2)),this.enemyteam=new a("enemy",l([...r(y)],1,2)),this.positions=new Set(Array(this.boardSize**2).keys()),this.gameState.level=1,this.positionTeams(1),this.gamePlay.redrawPositions(this.playerteam.characters.concat(this.enemyteam.characters)),this.gameState.stage="select",this.setScore()}lose(){t.showError("You LOSE!"),this.startNew()}selectChar(e){"botselect"!==this.gameState.stage&&(this.gameState.selectedChar&&this.gamePlay.deselectCell(this.gameState.selectedChar.position),this.gamePlay.selectCell(e.position)),this.gameState.selectedChar=e,this.gamePlay.hideRanges(),this.findRanges(),p.find((t=>t.type===e.character.type))&&this.gamePlay.showRanges(e.moveRange,e.attackRange)}findRange(e,t,a,s){const i=new Set,{row:r,col:l}=t,o=l-a<=0?l-1:a,h=l+a>=this.boardSize?this.boardSize-l:a,n=r-a<=0?r-1:a,c=r+a>=this.boardSize?this.boardSize-r:a;for(let t=-n;t<=c;t+=1)for(let a=-o;a<=h;a+=1)"attack"===s?i.add(e+t*this.boardSize+a):Math.abs(t)!==Math.abs(a)&&0!==t&&0!==a||i.add(e+t*this.boardSize+a);return Array.from(i).filter((t=>t>=0&&t<this.boardSize**2&&t!==e))}findRanges(){const e=this.gameState.selectedChar,t=Math.floor(e.position/this.boardSize)+1,a=e.position-this.boardSize*(t-1)+1;e.attackRange=this.findRange(e.position,{row:t,col:a},e.character.atkradius,"attack"),e.moveRange=this.findRange(e.position,{row:t,col:a},e.character.moveradius,"move")}async onCellClick(e){const{stage:a}=this.gameState;if("select"===a&&!this.positions.has(e)){const a=this.playerteam.characters.concat(this.enemyteam.characters).filter((t=>t.position===e))[0];return this.playerteam.characters.includes(a)?(this.selectChar(a),void(this.gameState.stage="move")):void t.showError("Выберите персонажа СВОЕЙ команды!")}const s="move"===a?this.playerteam.characters:this.enemyteam.characters,i="move"===a?this.enemyteam.characters:this.playerteam.characters;if(this.positions.has(e)){const s=this.gameState.selectedChar;s.moveRange.includes(e)?(this.gamePlay.deselectCell(s.position),this.positions.add(s.position),this.positions.delete(e),s.position=e,this.gamePlay.redrawPositions(this.playerteam.characters.concat(this.enemyteam.characters)),"botmove"!==a&&this.botMove(),this.gameState.stage="select"):(t.showError("Недоступно!"),this.gameState.stage="move")}else{const r=s.filter((t=>t.position===e))[0];if(r)this.selectChar(r,e),this.gameState.stage="move";else{const r=this.gameState.selectedChar,l=i.filter((t=>t.position===e))[0];if(r.attackRange.includes(e)){const t=Math.max(r.character.attack-l.character.defence,.1*r.character.attack),o=this.gamePlay.showDamage(e,t);await o.then((()=>{l.character.health-=t,this.gamePlay.redrawPositions(this.playerteam.characters.concat(this.enemyteam.characters)),l.character.health<=0?(this.positions.add(e),"move"===a?this.enemyteam.characters.splice(this.enemyteam.characters.indexOf(l),1):this.playerteam.characters.splice(this.playerteam.characters.indexOf(l),1),"move"===a&&0===this.enemyteam.characters.length?this.levelUp():"botmove"===a&&0===this.playerteam.characters.length?this.lose():(this.gamePlay.redrawPositions(s.concat(i)),"botmove"!==a&&this.botMove(),this.gameState.stage="select")):(this.gamePlay.deselectCell(r.position),this.gamePlay.redrawPositions(s.concat(i)),"botmove"!==a&&this.botMove(),this.gameState.stage="select")}))}else t.showError("Цель слишком далеко!"),this.gameState.stage="move"}}}botMove(){this.gameState.stage="botselect";const e=this.enemyteam.characters,t=e[Math.floor(Math.random()*e.length)];this.selectChar(t);const a=this.playerteam.characters.filter((e=>t.attackRange.includes(e.position))).sort(((e,t)=>t.character.health-e.character.health))[0];if(this.gameState.stage="botmove",a)this.onCellClick(a.position);else{const e=t.moveRange.filter((e=>this.positions.has(e))),a=e[Math.floor(Math.random()*e.length)];this.positions.add(t.position),this.positions.delete(a),t.position=a,this.gamePlay.redrawPositions(this.playerteam.characters.concat(this.enemyteam.characters))}}addCellClickEvent(){this.onCellClick=this.onCellClick.bind(this),this.gamePlay.addCellClickListener(this.onCellClick)}onNewGameClick(){this.startNew()}addNewGameClickEvent(){this.onNewGameClick=this.onNewGameClick.bind(this),this.gamePlay.addNewGameListener(this.onNewGameClick)}onLoadGameClick(){this.gamePlay.deselectCell(this.gameState.selectedChar.position),this.init()}addLoadGameClickEvent(){this.onLoadGameClick=this.onLoadGameClick.bind(this),this.gamePlay.addLoadGameListener(this.onLoadGameClick)}onSaveGameClick(){this.gameState.playerteam=this.playerteam,this.gameState.enemyteam=this.enemyteam,this.gameState.positions=this.positions,this.stateService.save(this.gameState)}addSaveGameClickEvent(){this.onSaveGameClick=this.onSaveGameClick.bind(this),this.gamePlay.addSaveGameListener(this.onSaveGameClick)}onCellEnter(e){if(this.positions.has(e)){const t=this.gameState.selectedChar;t&&t.moveRange.includes(e)?this.gamePlay.setCursor(d):this.gamePlay.setCursor(g)}else{const t=this.playerteam.characters.concat(this.enemyteam.characters).filter((t=>t.position===e))[0].character;if(this.gamePlay.showCellTooltip(`🎖 ${t.level} ⚔ ${t.attack} 🛡 ${t.defence} ❤ ${t.health} `,e),"move"===this.gameState.stage){const t=this.gameState.selectedChar;this.enemyteam.characters.filter((t=>t.position===e))[0]?t.attackRange.includes(e)?(this.gamePlay.setCursor(m),this.gamePlay.selectCell(e,"red")):this.gamePlay.setCursor(g):this.gamePlay.setCursor(d)}else this.playerteam.characters.filter((t=>t.position===e))[0]?this.gamePlay.setCursor(d):this.gamePlay.setCursor(g)}}addCellEnterEvent(){this.onCellEnter=this.onCellEnter.bind(this),this.gamePlay.addCellEnterListener(this.onCellEnter)}onCellLeave(e){"select"!==this.gameState.stage&&this.gameState.selectedChar.position===e||this.gamePlay.deselectCell(e),this.gamePlay.hideCellTooltip(e),this.gamePlay.setCursor(c)}addCellLeaveEvent(){this.onCellLeave=this.onCellLeave.bind(this),this.gamePlay.addCellLeaveListener(this.onCellLeave)}}(v,u);C.init()}();