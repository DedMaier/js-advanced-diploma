!function(){"use strict";class e{constructor(){this.boardSize=8,this.container=null,this.boardEl=null,this.cells=[],this.cellClickListeners=[],this.cellEnterListeners=[],this.cellLeaveListeners=[],this.newGameListeners=[],this.saveGameListeners=[],this.loadGameListeners=[]}bindToDOM(e){if(!(e instanceof HTMLElement))throw new Error("container is not HTMLElement");this.container=e}drawUi(e){this.checkBinding(),this.container.innerHTML='\n      <div class="controls">\n        <button data-id="action-restart" class="btn">New Game</button>\n        <button data-id="action-save" class="btn">Save Game</button>\n        <button data-id="action-load" class="btn">Load Game</button>\n      </div>\n      <div class="board-container">\n        <div data-id="board" class="board"></div>\n      </div>\n    ',this.newGameEl=this.container.querySelector("[data-id=action-restart]"),this.saveGameEl=this.container.querySelector("[data-id=action-save]"),this.loadGameEl=this.container.querySelector("[data-id=action-load]"),this.newGameEl.addEventListener("click",(e=>this.onNewGameClick(e))),this.saveGameEl.addEventListener("click",(e=>this.onSaveGameClick(e))),this.loadGameEl.addEventListener("click",(e=>this.onLoadGameClick(e))),this.boardEl=this.container.querySelector("[data-id=board]"),this.boardEl.classList.add(e);for(let e=0;e<this.boardSize**2;e+=1){const a=document.createElement("div");a.classList.add("cell","map-tile","map-tile-"+((t=e)%(s=this.boardSize)==0?t<s?"top-left":t===s*(s-1)?"bottom-left":"left":t%s==7?t<s?"top-right":t===s**2-1?"bottom-right":"right":0<t&&t<s?"top":t>s*(s-1)?"bottom":"center")),a.addEventListener("mouseenter",(e=>this.onCellEnter(e))),a.addEventListener("mouseleave",(e=>this.onCellLeave(e))),a.addEventListener("click",(e=>this.onCellClick(e))),this.boardEl.appendChild(a)}var t,s;this.cells=Array.from(this.boardEl.children)}redrawPositions(e){for(const e of this.cells)e.innerHTML="";for(const s of e){const e=this.boardEl.children[s.position],a=document.createElement("div");a.classList.add("character",s.character.type);const i=document.createElement("div");i.classList.add("health-level");const n=document.createElement("div");n.classList.add("health-level-indicator","health-level-indicator-"+((t=s.character.health)<15?"critical":t<50?"normal":"high")),n.style.width=`${s.character.health}%`,i.appendChild(n),a.appendChild(i),e.appendChild(a)}var t}addCellEnterListener(e){this.cellEnterListeners.push(e)}addCellLeaveListener(e){this.cellLeaveListeners.push(e)}addCellClickListener(e){this.cellClickListeners.push(e)}addNewGameListener(e){this.newGameListeners.push(e)}addSaveGameListener(e){this.saveGameListeners.push(e)}addLoadGameListener(e){this.loadGameListeners.push(e)}onCellEnter(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellEnterListeners.forEach((e=>e.call(null,t)))}onCellLeave(e){e.preventDefault();const t=this.cells.indexOf(e.currentTarget);this.cellLeaveListeners.forEach((e=>e.call(null,t)))}onCellClick(e){const t=this.cells.indexOf(e.currentTarget);this.cellClickListeners.forEach((e=>e.call(null,t)))}onNewGameClick(e){e.preventDefault(),this.newGameListeners.forEach((e=>e.call(null)))}onSaveGameClick(e){e.preventDefault(),this.saveGameListeners.forEach((e=>e.call(null)))}onLoadGameClick(e){e.preventDefault(),this.loadGameListeners.forEach((e=>e.call(null)))}static showError(e){alert(e)}static showMessage(e){alert(e)}selectCell(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"yellow";this.deselectCell(e),this.cells[e].classList.add("selected",`selected-${t}`)}deselectCell(e){const t=this.cells[e];t.classList.remove(...Array.from(t.classList).filter((e=>e.startsWith("selected"))))}showCellTooltip(e,t){this.cells[t].title=e}hideCellTooltip(e){this.cells[e].title=""}showDamage(e,t){return new Promise((s=>{const a=this.cells[e],i=document.createElement("span");i.textContent=t,i.classList.add("damage"),a.appendChild(i),i.addEventListener("animationend",(()=>{a.removeChild(i),s()}))}))}setCursor(e){this.boardEl.style.cursor=e}checkBinding(){if(null===this.container)throw new Error("GamePlay not bind to DOM")}}class t{static from(e){return e&&"object"==typeof e?e:null}}var s={1:"prairie",2:"desert",3:"arctic",4:"mountain"};class a{constructor(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"generic";if(this.level=e,this.attack=0,this.defence=0,this.health=50,this.type=t,"Character"===new.target.name)throw new Error("not allowed to  create object by new Character")}}class i{constructor(e,t){if(!(e instanceof a))throw new Error("character must be instance of Character or its children");if("number"!=typeof t)throw new Error("position must be a number");this.character=e,this.position=t}}class n extends a{constructor(e){super(e),this.attack=25,this.defence=25,this.health=100,this.type="bowman",this.distance=2,this.distanceAttack=2}}class o extends a{constructor(e){super(e),this.attack=40,this.defence=10,this.health=100,this.type="swordsman",this.distance=4,this.distanceAttack=1}}class r extends a{constructor(e){super(e),this.attack=10,this.defence=40,this.health=100,this.type="magician",this.distance=1,this.distanceAttack=4}}class l extends a{constructor(e){super(e),this.attack=10,this.defence=10,this.health=100,this.type="daemon",this.distance=1,this.distanceAttack=4}}class h extends a{constructor(e){super(e),this.attack=40,this.defence=10,this.health=100,this.type="undead",this.distance=4,this.distanceAttack=1}}class c extends a{constructor(e){super(e),this.attack=25,this.defence=25,this.health=100,this.type="vampire",this.distance=2,this.distanceAttack=2}}class d{static getStartUserTeam(){return[new n(1),new o(1)]}static getUserTeam(){return[n,o,r]}static getEnemyTeam(){return[l,h,c]}}function m(e,t,s){const a=function*(e,t){for(;;){const s=Math.floor(Math.random()*e.length),a=Math.floor(Math.random()*t+1);yield new e[s](a)}}(e,t),i=[];for(let e=0;e<s;e+=1)i.push(a.next().value);return i}const u="🎖",p="⚔",v="🛡",g="❤";function y(e,t){const s=[],a=Math.floor(e/8),i=e%8;for(let e=1;e<=t;e+=1)i+e<8&&s.push(8*a+(i+e)),i-e>=0&&s.push(8*a+(i-e)),a+e<8&&s.push(8*(a+e)+i),a-e>=0&&s.push(8*(a-e)+i),a+e<8&&i+e<8&&s.push(8*(a+e)+(i+e)),a-e>=0&&i-e>=0&&s.push(8*(a-e)+(i-e)),a+e<8&&i-e>=0&&s.push(8*(a+e)+(i-e)),a-e>=0&&i+e<8&&s.push(8*(a-e)+(i+e));return s}var w="auto",f="pointer",C="crosshair",L="not-allowed";let P=[],T=[],M=0;const E=new e;E.bindToDOM(document.querySelector("#game-container"));const b=new class{constructor(e){this.storage=e}save(e){this.storage.setItem("state",JSON.stringify(e))}load(){try{return JSON.parse(this.storage.getItem("state"))}catch(e){throw new Error("Invalid state")}}}(localStorage),k=new class{constructor(e,t){this.gamePlay=e,this.stateService=t,this.userTeam=[],this.enemyTeam=[],this.level=1,this.index=0,this.move="user",this.selected=!1,this.activeCharacter={},this.stateService=t,this.point=0}events(){this.gamePlay.addCellEnterListener(this.onCellEnter.bind(this)),this.gamePlay.addCellLeaveListener(this.onCellLeave.bind(this)),this.gamePlay.addCellClickListener(this.onCellClick.bind(this)),this.gamePlay.addNewGameListener(this.onNewGame.bind(this)),this.gamePlay.addSaveGameListener(this.onSaveGame.bind(this)),this.gamePlay.addLoadGameListener(this.onLoadGame.bind(this))}init(){this.events(),this.gamePlay.drawUi(s[this.level]),this.userTeam=d.getStartUserTeam(),this.level=1,this.enemyTeam=m(d.getEnemyTeam(),1,2),this.addPositionCharacted(this.userTeam,this.enemyTeam),this.gamePlay.redrawPositions([...P,...T])}addPositionCharacted(e,t){for(let t=0;t<e.length;t+=1){let s=this.randomUserPosition();P.push(new i(e[t],s))}for(let e=0;e<t.length;e+=1){let s=this.randomEnemyPosition();T.push(new i(t[e],s))}}randomUserPosition(){return 8*Math.floor(8*Math.random())+Math.floor(2*Math.random())}randomEnemyPosition(){return 8*Math.floor(8*Math.random())+(Math.floor(2*Math.random())+6)}nextLevel(){if(this.move="user",this.gamePlay.drawUi(s[this.level]),2===this.level)this.userTeam=m(d.getUserTeam(),1,1),this.enemyTeam=m(d.getEnemyTeam(),2,this.userTeam.length+P.length),this.addPositionCharacted(this.userTeam,this.enemyTeam);else if(3===this.level)this.userTeam=m(d.getUserTeam(),2,2),this.enemyTeam=m(d.getEnemyTeam(),3,this.userTeam.length+P.length),this.addPositionCharacted(this.userTeam,this.enemyTeam);else{if(4!==this.level)return void e.showMessage(`Ваш результат ${this.ppoint}. Лучший результат ${this.maxPoint}`);this.userTeam=m(d.getUserTeam(),3,2),this.enemyTeam=m(d.getEnemyTeam(),4,this.userTeam.length+P.length),this.addPositionCharacted(this.userTeam,this.enemyTeam)}}async onCellClick(t){if(this.index=t,"not-allowed"===this.gamePlay.boardEl.style.cursor)e.showError("Неверное действие!");else if("user"===this.move&&-1!==this.getIndex([...P]))this.gamePlay.deselectCell(M),this.gamePlay.selectCell(t),M=t,this.selected=!0,this.activeCharacter=[...P].find((e=>e.position===t)),console.log(this.activeCharacter);else if(this.selected&&"pointer"===this.gamePlay.boardEl.style.cursor)this.activeCharacter.position=t,this.gamePlay.deselectCell(t),this.gamePlay.deselectCell(M),this.gamePlay.redrawPositions([...P,...T]),this.move="enemy",this.selected=!1,this.enemyMove();else if(this.selected&&"crosshair"===this.gamePlay.boardEl.style.cursor){const e=[...T].find((e=>e.position===t));this.gamePlay.deselectCell(t),this.gamePlay.deselectCell(M),this.gamePlay.setCursor(w),this.selected=!1,await this.userAttack(this.activeCharacter.character,e),T.length>0&&this.enemyMove()}}onCellEnter(e){this.index=e;for(const s of[...P,...T])s.position===e&&this.gamePlay.showCellTooltip((t=s.character,`${u}${t.level}${p}${t.attack}${v}${t.defence}${g}${t.health}`),e);var t;if(this.selected){const t=y(this.activeCharacter.position,this.activeCharacter.character.distance),s=y(this.activeCharacter.position,this.activeCharacter.character.distanceAttack);-1!==this.getIndex([...P])?this.gamePlay.setCursor(f):t.includes(e)&&-1===this.getIndex([...P,...T])?(this.gamePlay.selectCell(e,"green"),this.gamePlay.setCursor(f)):s.includes(e)&&-1!==this.getIndex([...T])?(this.gamePlay.selectCell(e,"red"),this.gamePlay.setCursor(C)):this.gamePlay.setCursor(L)}}onNewGame(){this.userTeam=[],this.enemyTeam=[],P=[],T=[],this.init()}onSaveGame(){const s=this.maxPoints(),a={point:this.point,maxPoint:s,level:this.level,userTeamPositions:P,enemyTeamPositions:T};this.stateService.save(t.from(a)),e.showMessage("Game is saved!")}onLoadGame(){try{const t=this.stateService.load();t&&(this.point=t.point,this.level=t.level,P=t.userTeamPositions,T=t.enemyTeamPositions,this.gamePlay.drawUi(s[this.level]),this.gamePlay.redrawPositions([...P,...T])),e.showMessage("Game is loaded!")}catch(t){e.showError("Something is wrong! Memory is empty"),this.onNewGame()}}maxPoints(){let e=0;try{const t=this.stateService.load();t&&(e=Math.max(t.maxPoint,this.point))}catch(t){e=this.point}return e}enemyMove(){if(this.move="enemy"){for(let e of[...T]){const t=y(e.position,this.activeCharacter.character.distanceAttack),s=this.enemyAttack(t);if(null!==s)return void this.enemyTeamAttack(e.character,s)}const e=Math.floor(Math.random()*[...T].length),t=[...T][e],s=t.character.distance;let a,i,n,o,r;const l=this.positionRow(t.position),h=this.positionColumn(t.position);let c={};for(const e of[...P]){const t=this.positionRow(e.position),s=this.positionColumn(e.position);n=l-t,o=h-s,r=Math.abs(n)+Math.abs(o),(void 0===c.steps||r<c.steps)&&(c={steprow:n,stepcolumn:o,steps:r,positionRow:t,positionColumn:s})}Math.abs(c.steprow)===Math.abs(c.stepcolumn)?Math.abs(c.steprow)>s?(a=l-s*Math.sign(c.steprow),i=h-s*Math.sign(c.stepcolumn),t.position=this.rowColumnToIndex(a,i)):(a=l-(c.steprow-1*Math.sign(c.steprow)),i=h-(c.stepcolumn-1*Math.sign(c.steprow)),t.position=this.rowColumnToIndex(a,i)):0===c.stepcolumn?Math.abs(c.steprow)>s?(a=l-s*Math.sign(c.steprow),t.position=this.rowColumnToIndex(a,h)):(a=l-(c.steprow-1*Math.sign(c.steprow)),t.position=this.rowColumnToIndex(a,h)):0===c.steprow?Math.abs(c.stepcolumn)>s?(i=h-s*Math.sign(c.stepcolumn),t.position=this.rowColumnToIndex(l,i)):(i=h-(c.stepcolumn-1*Math.sign(c.stepcolumn)),t.position=this.rowColumnToIndex(l,i)):Math.abs(c.steprow)>Math.abs(c.stepcolumn)?Math.abs(c.steprow)>s?(a=l-s*Math.sign(c.steprow),t.position=this.rowColumnToIndex(a,h)):(a=l-c.steprow,t.position=this.rowColumnToIndex(a,h)):Math.abs(c.stepcolumn)>s?(i=h-s*Math.sign(c.stepcolumn),t.position=this.rowColumnToIndex(l,i)):t.position=this.rowColumnToIndex(l,h),this.gamePlay.redrawPositions([...P,...T]),this.move="user"}}enemyAttack(e){for(const t of[...T])if(e.includes(t.position))return t;return null}onCellLeave(e){this.gamePlay.hideCellTooltip(e),this.gamePlay.deselectCell(e),this.gamePlay.setCursor(w)}getIndex(e){return e.findIndex((e=>e.position===this.index))}positionRow(e){return Math.floor(e/this.gamePlay.boardSize)}positionColumn(e){return e%this.gamePlay.boardSize}rowColumnToIndex(e,t){return 8*e+t}async userAttack(e,t){const s=t.character;let a=Math.max(e.attack-s.defence,.1*e.attack);if(a=Math.floor(a),await this.gamePlay.showDamage(t.position),s.health-=a,this.move="enemy",s.health<=0&&(T=T.filter((e=>e.position!==t.position)),0===T.length)){for(const e of P)this.point+=e.character.health,e.character.level+=1,e.character.attack=Math.floor(Math.max(e.character.attack,e.character.attack*(1.8-e.character.health/100))),e.character.defence=Math.floor(Math.max(e.character.defence,e.character.defence*(1.8-e.character.health/100))),e.character.health=e.character.health+80<100?e.character.health+80:100;this.level+=1,this.nextLevel()}this.gamePlay.redrawPositions([...P,...T])}async enemyTeamAttack(t,s){const a=s.character;let i=Math.max(t.attack-a.defence,.1*t.attack);i=Math.floor(i),await this.gamePlay.showDamage(s.position),a.health-=i,this.move="user",a.health<=0&&(P=P.filter((e=>e.position!==s.position))),0===P.length&&e.showMessage("Game Over!!!"),this.gamePlay.redrawPositions([...P,...T])}}(E,b);k.init()}();